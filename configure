#!/bin/sh

PREFIX="/usr/local"
VERSION="0.9.1"

verbose=0
debug=0

printc () {
  printf "\033[%s;1m%b\033[0m" $1 "$2"
}

ok () {
  printc 32 "\tOK\n"
}

fail () {
  printc 31 "\tFAIL\n"
}

warn () {
  printc 33 "warning: "
  printf "%b\n" "$1"
}

status () {
  printf $2
  if [ $1 = 0 ]; then
    ok
  else
    fail
    exit 1
  fi
}

bin () {
  type $1 >/dev/null 2>&1
  status $? $1
}

lib () {
  pkg-config $1 >/dev/null 2>&1
  # $? == 0?
  status $? $1
}

bins () {
  printc 37 "checking building tools..\n"
  bin pkg-config
  bin rm
  bin mkdir
  bin cp
  bin chmod
  bin strip
  bin gzip
}

libs () {
  printc 37 "checking libraries..\n"
  LIB_NAMES="x11 xft fontconfig freetype2"
  for i in $LIB_NAMES; do
    lib $i
  done
}

append () {
  printf "%b\n" "$*" >>config.mk
}

config () {
  printc 37 "creating configuration file"
  append "# Generated by configure script"
  append "BIN_DIR = $PREFIX/bin"
  append "MAN_DIR = $PREFIX/share/man/man1\n"
  if [ $verbose = 1 ]; then
    append "QUIET_CC = "
    append "QUIET_LINK = "
  else
    append "QUIET_CC = @echo 'CC '\$@;"
    append "QUIET_LINK = @echo 'LINK '\$@;"
  fi

  append "\nCFLAGS = `pkg-config --cflags $LIB_NAMES` -DVERSION=\\\"$VERSION\\\" -D_XOPEN_SOURCE=600"
  [ $debug = 1 ] && append "CFLAGS += -g -DDEBUG" || append "CFLAGS += -O3"
  append "\nLIBS = `pkg-config --libs $LIB_NAMES`"
  
  ok
}

printf "configure: create 'config.mk' include file\n"
for arg; do
  opt=${arg%%=*}
  var=${arg#*=}
  case "$opt" in
    --verbose)
      verbose=1
    ;;
    --debug)
      debug=1
    ;;
    --prefix)
      PREFIX="$var"
    ;;
    -h|--help)
      printf "usage: ./"
      printc 37 "configure "
      printf "[--verbose] [--debug] [--prefix=<dir>]\n"
      exit 1
    ;;
    *)
      warn "unknown option $opt" >&2
    ;;
  esac
done

bins
libs
config

printf "type "
printc 37 "make"
printf " to build the program\n"
